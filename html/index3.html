<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="jquery-ui.min.css">
<script src="external/jquery/jquery.js"></script>
<script src="jquery-ui.min.js"></script>
<script src="chart.js"></script>
<link rel="stylesheet" href="ost.css">
</head>
<body>
<div id="OST"></div>
<div id='allmessages'></div>
</body>
</html>

<script>
function removeblanks (t) {
    var r=t.replace(' ','');
    if (r==t) {
        return r;
    } else {
        return removeblanks(r);
    }
}
jQuery.fn.sortDivs = function sortDivs() {
    $("> div", this[0]).sort(dec_sort).appendTo(this[0]);
    function dec_sort(a, b){ return ($(b).data("order")) < ($(a).data("order")) ? 1 : -1; }
}
var ur = window.location.origin.replace("http://", "");
var result = ur.replace("http://", "");
var wsUri = "ws://"+ur+":9624";            
var websocket = null;
$("[id='allmessages']").prop('readonly', true);
$("[id='allmessages']").width("98%");
$("[id='allmessages']").on("dblclick", function () {
    $("[id='allmessages']").children().remove();
});

$(document).ready(function()
{
    initWebSocket();

});


function initWebSocket() {
    try {
        if (typeof MozWebSocket == 'function') WebSocket = MozWebSocket;
        if ( websocket && websocket.readyState == 1 ) websocket.close();
        
        websocket = new WebSocket( wsUri );
        websocket.onopen = function (evt) {
            console.log("CONNECTED");
            websocket.send( "{\"evt\":\"readall\"}");
        };
        websocket.onclose = function (evt) {
            console.log("DISCONNECTED");
            $("div#OST").append("Lost backend connection, reconnecting...");
            //window.location.reload();
            setTimeout(function() {
                window.location.reload(); 
                //initWebSocket();
            },3000);
        };

        websocket.onmessage = function (evt) {
            var obj = JSON.parse( evt.data );
            console.log(obj);
            //if ((obj.event == 'appendproperty')) {console.log(obj)};
            //if ((obj.event == 'updateproperty')&&(obj.property.propname=='grid')) {console.log(obj)};
            if (obj.evt == 'moduledump') {
                m=obj.mod;
                l=obj.dta.moduleLabel.value;
                buildmodule(m,l);
               
                var properties = obj.dta;
                $.each( properties, function(iprop,prop) {
                    builddevcat(m,prop);
                    buildgroup(m,prop);
                    buildproperty(m,prop,iprop);
                })
                $.each( properties, function(iprop,prop) {
                    d = removeblanks(prop.devcat);
                    $("div#devDIV"+m+d).tabs(); /* this shouldn't be here */    
                })                
                $("div#modDIV"+m).tabs();       /* this shouldn't be here */    
                
            }
            
            if (obj.evt == 'setpropvalue') {
                var dta=obj.dta;
                var mod=obj.mod;
                //console.log( "setpropvalue :"+mod);
                $.each( dta, function( iprop, prop) {
                    //console.log( "setpropvalue :",iprop,"/",nnp);
                    setattributes(mod,prop,iprop);
                });                  

            }
           
            if (obj.evt == 'setattributes') {
                var dta=obj.dta;
                var mod=obj.mod;
                $.each( dta, function( iprop, prop) {
                    //console.log( "setattributes :",iprop,"/",nnp);
                    setattributes(mod,prop,iprop);
                });                  

            }
            if ((obj.evt == 'addprop')||(obj.evt == 'addelt')) {
                var dta=obj.dta;
                var mod=obj.mod;
                $.each( dta, function(iprop,prop) {
                    d = removeblanks(prop.devcat);
                    g = removeblanks(prop.group);
                    p = removeblanks(iprop);
                    builddevcat(mod,prop);
                    buildgroup(mod,prop);                    
                    buildproperty(mod,prop,iprop);                  
                })                
                $.each( dta, function(iprop,prop) {
                    d = removeblanks(prop.devcat);
                    $("div#devDIV"+mod+d).tabs("refresh"); 
                })                
                $("div#modDIV"+mod).tabs("refresh");       /* this shouldn't be here */  

            }

            if (obj.evt == 'delprop') { 
                    var p=removeblanks(obj.mod+obj.key);
                    var mod=removeblanks(obj.mod);
                    dev=$("div#P"+ p ).data("devcat");
                    dev=removeblanks(obj.mod+dev);
                    group=$("#P"+ p ).data("group");
                    group=removeblanks(dev+group);
                    $( "#tab3"+ p ).remove()
                    $( "#tab2"+ p ).remove()
                    $( "#tab"+ p ).remove()
                    $( "#P"+ p ).children().remove();

                    $( "#P"+ p ).remove();
                    if (!($("#grpUL"+ group ).children().length > 0)){
                        //console.log("REMOVE GROUP "+group);
                        $("#grpDIV"+ group ).remove();
                        $("#grpLI"+ group ).remove();
                        $("#grpLIL"+ group ).remove();
                        $("#grpUL" + group ).remove();
                    }
                    if (!($("#devUL"+ dev).children().length > 0)){
                        //console.log("REMOVE DEVICE "+dev);
                        $("#devDIV"+ dev ).remove();
                        $("#devLI"+ dev ).remove();
                        $("#devLIL"+ dev ).remove();
                        $("#devUL" + dev ).remove();
                    }
                    if (!($("#modUL"+ mod).children().length > 0)){
                        $("#modDIV"+ mod ).remove();
                        $("#modH1"+ mod ).remove();
                        $("#modUL"+ mod ).remove();
                    }

                
            }
            
        };
        
        websocket.onerror = function (evt) {
            console.log('ERROR: ' + evt.data);
        };
    } 
    catch (exception) {
        console.log('ERROR: ' + exception);
    }
}

function stopWebSocket() {
    if (websocket)  websocket.close();
}
            
function buildmodule(m,l) {

    if  (!($("div#modDIV"+m).length)) {
        header = "<h3  id=modH1"+m+">"+l;

        if (m!="mainctl") {
            header=header+"<span id='savemod"+m + "'class='ui-icon ui-icon-disk' data-m="+m+"></span>";
            header=header+"<span id='saveasmod"+m + "'class='ui-icon ui-icon-copy' data-m="+m+"></span>";
            header=header+"<span id='closemod"+m + "'class='ui-icon ui-icon-close' data-m="+m+" data-l='"+l+"'></span>";
        }

        header = header + "</h3>";

        $("div#OST").append(header);
        $("div#OST").append("<div id=modDIV"+m+"></div>");
        $("div#modDIV"+m).append("<ul id=modUL"+m+"></ul>");
    };
    $("#OST").accordion({header: "h3",collapsible: true,autoHeight: false,navigation: true,heightStyle: "content" });
    $("#OST").accordion("refresh");  

    if (m!="mainctl") {
        $("[id='closemod"+m+"']").css("color", "red");

        $("[id='closemod"+m+"']").css("float", "right");
        $("[id='saveasmod"+m+"']").css("float", "right");
        $("[id='savemod"+m+"']").css("float", "right");

        $("[id='savemod"+m+"']").on("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                //if (!confirm('Confirm save')) return;
                var m=$(this).data("m");
                //console.log("clic:",p.propertyLabel);
                var obj = jQuery.parseJSON("{\"evt\":\"setproperty\",\"mod\":\""+m+"\",\"dta\":{\"profileactions\":"+"{\"indi\":1,\"elements\":{\"save\":{\"value\":true}}}}}");
                console.log(obj);
                websocket.send(JSON.stringify(obj));
        });

        $("[id='closemod"+m+"']").on("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                var m=$(this).data("m");
                var l=$(this).data("l");
                if (!confirm("Really close module \'" + l + "\' ?")) return;
                //console.log("clic:",p.propertyLabel);
                var obj = jQuery.parseJSON("{\"evt\":\"setproperty\",\"mod\":\""+m+"\",\"dta\":{\"moduleactions\":"+"{\"indi\":1,\"elements\":{\"kill\":{\"value\":true}}}}}");
                console.log(obj);
                websocket.send(JSON.stringify(obj));
        });
    }


    
}

function builddevcat(m,prop) {
    dd=removeblanks(prop.devcat);
    if  (!($("[id='devDIV"+m+dd+"']").length >0)) {
        //console.log('BUILD DEVCAT ' + m + "-"+ d + "-"+ l + "-");
        $("[id='modDIV"+m+"']").append("<div id='devDIV"+m+dd+"'></div>");
        $("[id='modUL"+m+"']").append("<li id='devLI"+m+dd+"'><a href=#devDIV"+m+dd+">"+prop.devcat+"</a></li>");
        $("[id='devDIV"+m+dd+"']").append("<ul id='devUL"+m+dd+"'></ul>");
    };
    //$("#D"+m).tabs("refresh");  
}

function buildgroup(m,prop) {
    dd=removeblanks(prop.devcat);
    gg=removeblanks(prop.group);
    if  (!($("[id='grpDIV"+m+dd+gg+"']").length > 0)) {
        //console.log('BUILD GROUP ' + m + "-" + dd + "-"+ gg+ "-");
        $("[id='devDIV"+m+dd+"']").append("<div id='grpDIV"+m+dd+gg+"'></div>");
        $("[id='devUL"+m+dd+"']").append("<li id='grpLIL"+m+dd+gg+"'><a href=#grpDIV"+m+dd+gg+">"+prop.group+"</a></li>");
        $("[id='grpDIV"+m+dd+gg+"']").append("<ul id='grpUL"+m+dd+gg+"'></ul>");
    };
}
function buildproperty(m,p,n) {
    var d=removeblanks(p.devcat);
    var g=removeblanks(p.group);
    var mp=removeblanks(m+n);
    if  (!($("[id='P"+mp+"']").length)) {
        var div="<div id=P"+mp+" data-devcat='"+d+"' data-group='"+g+"' data-key='"+n+"' data-order='"+p.order+"' '>";
        div = div + "<strong id='status"+mp+"' >"+'\u25ef'+"</strong>";                  // status icon
        div = div + "<strong id=title"+mp+" > "+p.propertyLabel+" </strong>";            // label 
        // Edit button is added only for writable numbers and texts (not booleans)
        var addEditBtn = false;
        if (p.permission=="1"||p.permission=="2") {
            $.each( p.elements, function( ii, i ) {
                if ( (jQuery.type(i.value)=='string')||(jQuery.type(i.value)=='number') ) addEditBtn = true;
            })                
        }
        if (addEditBtn) {
            div = div + "<button class='ui-button ui-widget ui-corner-all' id=edit"+mp;
            div = div + " data-m"+m+" data-mp="+mp+" data-key=\"\"";
            div = div + "><span class='ui-icon ui-icon-pencil'></span></button>";
        }

        // show elements values
        div = div + "<table>";
        if (p.hasOwnProperty('value')) {
               div = div + "<tr><br>"+p.value+"</tr>";
        }
        if (n=="message") {
            div = div + "<tr><br><input type=text' id='message"+mp+"' class='text ui-widget ui-corner-all' width='auto'></tr>";
        }
        
        $.each( p.elements, function( ii, i ) {
            if ( (jQuery.type(i.value)=='string')) {
               div = div + "<tr><td><label for='"+ii+"'>"+i.elementLabel+"</label></td>";
               div = div + "<td><input type=text' id='elt"+mp+ii+"' value='"+i.value+"' class='text ui-widget-content ui-corner-all'></td></tr>";
            }
            if ( (jQuery.type(i.value)=='number')) {
               div = div + "<tr><td><label for='"+ii+"'>"+i.elementLabel+"</label></td>";
               div = div + "<td><input type=text' id='elt"+mp+ii+"' value='"+i.value+"' class='text ui-widget-content ui-corner-all'></td></tr>";
            }
        })                
        div = div + "</table>";
        if (p.hasOwnProperty('URL')) {
            div = div + "<div id='gal"+mp+"' data-m"+m+" data-mp="+mp+" data-key=\"\">";
            div = div + "<img id='im"+mp+"' src='"+p.URL+ "?"+ new Date().valueOf() +"' data-m"+m+" data-mp="+mp+" data-key=\"\" height='150'></div>";
        }
        // add switchs or radio for booleans
        var tt='checkbox';
        if (p.hasOwnProperty('rule')) {
            if (p.rule==0) tt='radio';
        }
        div = div + "<fieldset id='fs"+mp+"' >";
        $.each( p.elements, function( ii, i ) {
            if ( (jQuery.type(i.value)=='boolean')) {
                div = div + "<label for='sw"+mp+ii+"'>"+i.elementLabel+"</label>";
                div = div + "<input type="+tt+" name='sw"+mp+"' id='sw"+mp+ii+"' data-mp='"+mp+"' data-mpi='"+mp+ii+"'  >";
            }
        })                
        div = div + "</fieldset>";
        if (p.hasOwnProperty('grid')) {
            var arr;
            div = div + "<div id='grid"+mp+"' data-m"+m+" data-mp="+mp+" data-key=\"\"><table><tr>";
            $.each( p.elements, function( ii, i ) {
                div = div + "<th>"+i.elementLabel+"</th>";
                arr=i.gridvalues;                
            })                
            div = div + "</tr>";
            var ligne=0;
            for (const val of arr) {
                div = div + "<tr>";
                $.each( p.elements, function( ii, i ) {
                    div = div + "<td>"+i.gridvalues[ligne]+"</td>";
                })                
                ligne++;
                div = div + "</tr>";                
            }            
            div = div + "</table></div>";
        }

        
        
        div = div + "</div>";
        
        
        
        
        
        
        $("#grpUL"+m+d+g).append(div);


        $("[id='P"+mp+"']").data("prop",p);
        $("[id='P"+mp+"']").data("m",m);
        $("[id='P"+mp+"']").data("key",n);
        $("[id='P"+mp+"']").data("order",p.order);

        $("#grpUL"+m+d+g).sortDivs();

        $.each( p.elements, function( ii, i ) {
            if ( (jQuery.type(i.value)=='boolean')) {
                $("[id='sw"+mp+ii+"']").checkboxradio({icon: false});
                $("[id='sw"+mp+ii+"']").prop('checked', i.value).checkboxradio("refresh");
                // send message when check/uncheck
                $("[id='sw"+mp+ii+"']").change(function () {
                    var mpi=$(this).data("mpi");
                    var mp=$(this).data("mp");
                    var n=$("[id='P"+mp+"']").data("key");
                    var p=$("[id='P"+mp+"']").data("prop");
                    var check;
                    if (p.permission==1) check=true; else check = $(this).prop('checked');
                    var obj = jQuery.parseJSON("{\"evt\":\"setproperty\",\"mod\":\""+m+"\",\"dta\":{\""+n+"\":"+"{\"indi\":1,\"devcat\":\""+p.devcat+"\",\"elements\":{\""+ii+"\":{\"value\":"+check+"}}}}}");
                    console.log(obj);
                    websocket.send(JSON.stringify(obj)); 
                });        

            }
        })     

        // numbers and texts are readonly
        $.each( p.elements, function( ii, i ) {
            if ( (jQuery.type(i.value)=='string') || (jQuery.type(i.value)=='number') ) {
               $("[id='elt"+mp+ii+"']").prop('readonly', true);
            }
            //if ((jQuery.type(i.value)=='number') ) {
            //   $("[id='elt"+mp+ii+"']").spinner({numberFormat: "n"});
            //}
        })    
        $("[id='message"+mp+"']").prop('readonly', true);
        $("[id='message"+mp+"']").width("98%");
//         
        
        // Assign edit button behavior
        if (addEditBtn) {
            buildEditBtn(m,p,n);
        }       
        if (p.hasOwnProperty('URL')) {
            buildPhotoform(m,p,n);
        }

        //set attributes
        setattributes(m,p,n);
        
        
    }
    
}
function buildPhotoform(m,p,n) {
    var d=removeblanks(p.devcat);
    var g=removeblanks(p.group);
    var mp=removeblanks(m+n);
    $("[id='gal"+mp+"']").on("click", function () {    
            var mp=$(this).data("mp");
            var p=$("[id='P"+mp+"']").data("prop");
            var src=$("[id='im"+mp+"']").data("src");
            console.log("[id='im"+mp+"']");
            //console.log("clic:",p.propertyLabel);
            var form = "<div id='photo"+mp+"' title='"+p.propertyLabel+"' style='modal:true'><form>";
            console.log("<img id='imphoto"+mp+"' src='"+src+ "'  style='height: 100%; width: 100%; object-fit: contain'><div>");
            //form = form + "<img id='imphoto"+mp+"' src='"+p.URL+ "?"+ new Date().valueOf()+"'  style='height: 100%; width: 100%; object-fit: contain'><div>";
            form = form + "<img id='imphoto"+mp+"' src='"+src+ "'  style='height: 100%; width: 100%; object-fit: contain'><div>";
            form = form+"</form></div>";
            
            $("[id='P"+mp+"']").append(form);
            $("[id='photo"+mp+"']").data("mp",mp);
            $("[id='photo"+mp+"']").on( "dialogclose", function(event) {
                //event.preventDefault();
                //console.log("dialogclose");
                //$( "[id='photo"+mp+"']" ).dialog("close");
                $( "[id='photo"+mp+"']" ).remove();
            });
            
            
            $("[id='photo"+mp+"']").dialog({modal:true,resizable: false,width:'auto'});
    });
            
}
function buildEditBtn(m,p,n) {
    var d=removeblanks(p.devcat);
    var g=removeblanks(p.group);
    var mp=removeblanks(m+n);

    $("[id='edit"+mp+"']").on("click", function () {
            var mp=$(this).data("mp");
            var p=$("[id='P"+mp+"']").data("prop");
            //console.log("clic:",p.propertyLabel);
            var form = "<div id='form"+mp+"' title='"+p.propertyLabel+"' style='modal:true'><form>";
            form = form+"<fieldset><table>";
            $.each( p.elements, function( ii, i ) {
                    //console.log(jQuery.type(i.value));
                switch(jQuery.type(i.value)) {
                case 'string':
                    form = form+"<tr><td><label for='"+ii+"'>"+i.elementLabel+"</label></td>";
                    form = form+"<td><input type='text' name='form"+mp+ii+"' id='form"+mp+ii+"' value='"+i.value+"' class='text ui-widget-content ui-corner-all'></td></tr>";
                    break;
                case 'number':
                    form = form+"<tr><td><label for='"+ii+"'>"+i.elementLabel+"</label></td>";
                    form = form+"<td><input type='number' name='form"+mp+ii+"' id='form"+mp+ii+"' value='"+i.value+"' step='"+i.step+"' min='"+i.min+"' max='"+i.max+"' class='text ui-widget-content ui-corner-all'></td></tr>";
                    break;
                default:
                    // code block
                } 
            })  
            form = form+"</fieldset></table>";
            form = form+"<input type='submit' class='ui-button ui-widget ui-corner-all'>";
            form = form+"</form></div>";
            
            $("[id='P"+mp+"']").append(form);
            /*$.each( p.elements, function( ii, i ) {
                    //console.log(jQuery.type(i.value));
                switch(jQuery.type(i.value)) {
                case 'number':
                    $("[id='form"+mp+ii+"']").spinner();
                    break;
                default:
                    // code block
                } 
            })*/          
            $("[id='form"+mp+"']").data("mp",mp);
            $("[id='form"+mp+"']").on( "submit", function(event) {
                event.preventDefault();
                //console.log("submit");
                var mp=$(this).data("mp");
                var p=$("[id='P"+mp+"']").data("prop");
                var m=$("[id='P"+mp+"']").data("m");
                var n=$("[id='P"+mp+"']").data("key");
                var mess="{\"evt\":\"setproperty\",\"mod\":\""+m+"\",\"dta\":{\""+n+"\":{\"elements\":{";
                var virgule = "";
                $.each( p.elements, function( ii, i ) {
                    //console.log(mp+ii);
                    if ($("[id='form"+mp+ii+"']").length) { // to avoid booleans
                        //console.log(mp+ii);
                        //p.elements[ii].value=document.getElementById("form"+mp+ii).value;
                        switch(jQuery.type(i.value)) {
                        case 'string':
                            mess = mess + virgule + "\"" + ii + "\":{\"value\":\""+ document.getElementById("form"+mp+ii).value +"\"}";
                            virgule = ",";
                        break;
                        case 'number':
                            mess = mess + virgule + "\"" + ii + "\":{\"value\":"+ document.getElementById("form"+mp+ii).value +"}";
                            virgule = ",";
                        break;
                        default:
                            // code block
                        } 
                        
                    } 
                })                
                mess = mess + "}}}}";
                console.log(jQuery.parseJSON(mess));
                websocket.send(mess);
                var obj = jQuery.parseJSON("{\"evt\":\"setproperty\",\"mod\":\""+m+"\",\"dta\":{\""+n+"\":"+JSON.stringify(p)+"}}");
                $( "[id='form"+mp+"']" ).dialog("close");
                $( "[id='form"+mp+"']" ).remove();
            });
            
            
            $("[id='form"+mp+"']").dialog({modal:true,resizable: false,width:'auto'});
            
    });
    

}
function setattributes(m,p,n) {
    var mp=removeblanks(m+n);

    if (p.status=="0") $("[id='status"+mp+"']").text('\u25ef');       //white
    if (p.status=="1") $("[id='status"+mp+"']").text('\ud83d\udfe2'); // green
    if (p.status=="2") $("[id='status"+mp+"']").text('\ud83d\udfe1'); // yellow
    if (p.status=="3") $("[id='status"+mp+"']").text('\ud83d\udd34'); // red   
    if (n=="message") {
        $("[id='message"+mp+"']").val(p.value);
        $("[id='allmessages']").prepend("<a>"+p.value+"</a><br>");
    }
    if (p.hasOwnProperty('URL')) {
        $("[id='im"+mp+"']").prop("src",p.URL + "?"+ new Date().valueOf());
        $("[id='imphoto"+mp+"']").prop("src",p.URL + "?"+ new Date().valueOf());
    }
    
    $.each( p.elements   , function( ii, i) {
        $("[id='elt"+mp+ii+"']").val(i.value);
    });                  
    
}
function buildelts(m,prop,n) {


    nn=m+n;
    $.each( prop.elements, function( iitem, item ) {
        //console.log( "buildelts: " + m + "-"+ n + "-"+ iitem + "-" + Object.prototype.toString.call(item.value));
        nnn = nn+iitem;
        if ($("#"+nnn).length) {
            $("#"+nnn).val(item.value);
        } else {
             switch(jQuery.type(item.value)) {
            case 'string':
                $("#tab3"+nn + " tbody").append("<tr><td><small> "+item.elementLabel+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+n+" data-name="+iitem+" value='"+item.value+"'  label="+item.elementLabel+" /></td></tr>");
                break;
            case 'boolean':
                $("[id='tab3"+nn + "']").append("<button id=bbb"+nnn+" class='ui-button ui-widget ui-corner-all' backlogid=btn"+nnn
                +" value="+item.state
                +" data-value=\"\""
                +" data-btn=\"\" >"+item.elementLabel+"</button>");
                break;
            case 'number':
                $("#tab3"+nn + " tbody").append("<tr><td><small> "+item.elementLabel+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+n+" data-name="+iitem+" value='"+item.value+"'  label="+item.elementLabel+" /></td></tr>");
                break;
            default:
                // code block
            } 

            /*$("#tab3"+nn + " tbody").append("<tr><td><small> "+item.elementLabel+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+n+" data-name="+iitem+" value='"+item.value+"'  label="+item.elementLabel+" /></td></tr>");*/
            if ((prop.permission=="1"||prop.permission=="2")) {
                $("#"+nnn).css("background-color", "white");
            } else {
                $("#"+nnn).css("background-color", "gray");
            }
            
            //if (prop.permission=="2") {
            //    $("#tab3"+nn+ " tbody").append(
            //    "<tr><td><small>"+item.label+"</small></td><td>"
            //    +"<input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.text+"'  label="+item.text+" /></td></tr>"
            //    );
            //}
        
        }

    })


}                

</script>

