<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="jquery-ui.min.css">
<script src="external/jquery/jquery.js"></script>
<script src="jquery-ui.min.js"></script>
<link rel="stylesheet" href="ost.css">
</head><body><div id="OST"></div></body>
</html>

<script>

var ur = window.location.origin.replace("http://", "");
var result = ur.replace("http://", "");
var wsUri = "ws://"+ur+":9624";            
var websocket = null;

$(document).ready(function()
{
    initWebSocket();
});

function initWebSocket() {
    try {
        if (typeof MozWebSocket == 'function') WebSocket = MozWebSocket;
        if ( websocket && websocket.readyState == 1 ) websocket.close();
        
        websocket = new WebSocket( wsUri );
        websocket.onopen = function (evt) {
            console.log("CONNECTED");
            websocket.send( "{\"message\":\"readall\"}");
        };
        websocket.onclose = function (evt) {
            console.log("DISCONNECTED");
            $("#OST").empty();
            $("#OST").tabs("refresh");
        };
        websocket.onmessage = function (evt) {
            var obj = jQuery.parseJSON( evt.data );
            console.log(obj);
            if (obj.event == 'moduledump') {
                m=obj.module;
                l=obj.modulelabel;
                buildmodule(m,l);
                
                var devices = obj.devices;
                $.each( devices, function(idev,dev) {
                    d=dev.devicenameshort;
                    l=dev.devicename;
                    builddevice(m,d,l);

                    var groups = dev.groups;
                    $.each( groups, function(igro,gro) {
                        g=gro.groupnameshort;
                        l=gro.groupname;
                        buildgroup(m,d,g,l);
                        var props = gro.properties;
                        $.each( props, function(ipro,pro) {
                            buildproperty(m,d,g,pro);
                        })

                    })
                    $("div#D"+m+d).tabs();    

                })
                $("div#D"+m).tabs();    


            }
            if (obj.event == 'updateproperty') {
                p=obj.property;
                buildproperty(obj.module,p.devicenameshort,p.groupnameshort,p);
            }
            if (obj.event == 'createproperty') {
                p=obj.property;
                buildproperty(obj.module,p.devicenameshort,p.groupnameshort,p);
                if ($("#U"+ obj.module + p.devicenameshort + p.groupnameshort).is(':empty')){
                    buildgroup(obj.module,p.devicenameshort,p.groupnameshort,p.groupname);
                }
            }
            if (obj.event == 'removeproperty') {
                    var dev   = obj.module+obj.property.devicenameshort;
                    var group = dev+obj.property.groupnameshort;
                    var prop  = group+obj.property.propname;
                    //console.log("REMOVE PROP "+prop);
                    $( "div#P"+ prop ).children().remove();
                    $( "div#P"+ prop ).remove();
                    
                    if ($("#U"+ group).is(':empty')){
                        //console.log("REMOVE GROUP "+group);
                        $("#L"+ group ).remove();
                        $("#D"+ group ).remove();
                        $("#U"+ group ).remove();
                    }
                    if ($("#U"+ dev).is(':empty')){
                        //console.log("REMOVE DEVICE "+dev);
                        $("#L"+ dev ).remove();
                        $("#D"+ dev ).remove();
                        $("#U"+ dev ).remove();
                    }

                
            }
            
        };
        
        websocket.onerror = function (evt) {
            console.log('ERROR: ' + evt.data);
        };
    } 
    catch (exception) {
        console.log('ERROR: ' + exception);
    }
}

function stopWebSocket() {
    if (websocket)  websocket.close();
}
            
function buildmodule(m,l) {

    if  (!($("div#D"+m).length)) {
        $("div#OST").append("<h1  id=H"+m+">"+l+"</h1>");
        $("div#OST").append("<div id=D"+m+"></div>");
        $("div#D"+m).append("<ul id=U"+m+"></ul>");
        
    };
    $("#OST").accordion({header: "h1",collapsible: true,autoHeight: false,navigation: true,heightStyle: "content" });
    $("#OST").accordion("refresh");  
    
}

function builddevice(m,d,l) {
    //console.log('BUILD DEVICE ' + m + "-"+ d + "-"+ l + "-");
    if  (!($("div#D"+m+d).length)) {
        $("div#D"+m).append("<div id=D"+m+d+"></div>");
        $("#U"+m).append("<li id=L"+m+d+"><a href=#D"+m+d+">"+l+"</a></li>");
        $("div#D"+m+d).append("<ul id=U"+m+d+"></ul>");
    };
}

function buildgroup(m,d,g,l) {
    //console.log('BUILD GROUP ' + m + "-" + d + "-"+ g + "-"+ l + "-");
    if  (!($("div#"+m+d+g).length)) {
        $("div#D"+m+d).append("<div id=D"+m+d+g+"></div>");
        $("#U"+m+d).append("<li id=L"+m+d+g+"><a href=#D"+m+d+g+">"+l+"</a></li>");
        $("div#D"+m+d+g).append("<ul id=U"+m+d+g+"></ul>");
    };
    //$("div#D"+m+d).tabs();    
}

function buildproperty(m,d,g,p) {
    nn=m+d+g;
    nnp=nn+p.propname;
    if  (!($("div#P"+nnp).length)) {
        $("#U"+nn).append("<div id=P"+nnp+" ><table id=tab"+nnp+"><tr><td><stm+d+grong>"+p.label+"</strong></td><td></td></tr></table></div>");
    }
    if (p.hasOwnProperty('texts')) buildtexts(m,d,g,p);
    if (p.hasOwnProperty('numbers')) buildnumbers(m,d,g,p);
    if (p.hasOwnProperty('switches')) buildswitchs(m,d,g,p);
    if (p.hasOwnProperty('lights')) buildlights(m,d,g,p);
    //$("div#D"+m+d+g).tabs();    
}
function buildtexts(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.texts, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#"+nnn).length) {
            $("#"+nnn).val(item.text);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn + " tbody").append("<tr><td><small> "+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.text+"'  label="+item.text+" /></td></tr>");
            };
            if (prop.permission=="2") {
                $("#tab"+nn+ " tbody").append("<tr><td><small>"+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.text+"'  label="+item.text+" /><button class='ui-button ui-widget ui-corner-all' id=btn"+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+"  onClick=\"indi_text('"+nnn+"','"+m+"','"+d+"','"+p+"','"+item.name+"');\"    >set</button></td></tr>");
            }
        
        }

    })
}    
function buildnumbers(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.numbers, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#"+nnn).length) {
            $("#"+nnn).val(item.value);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn + " tbody").append("<tr><td><small> "+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.value+"'  label="+item.value+" /></td></tr>");
            };
            if (prop.permission=="2") {
                $("#tab"+nn+ " tbody").append("<tr><td><small>"+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.value+"'  label="+item.value+" /><button class='ui-button ui-widget ui-corner-all' id=btn"+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+"  onClick=\"indi_number('"+nnn+"','"+m+"','"+d+"','"+p+"','"+item.name+"');\"    >set</button></td></tr>");
            }
        
        }

    })
}    
function buildswitchs(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.switches, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#"+nnn).length) {
            $("#"+nnn).val(item.state);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn+ " tbody").append("<tr><td><small>"+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.state+"'  label="+item.state+" /></td></tr>");
            
            };
            if (prop.permission=="1" || prop.permission=="2") {
                $("#tab"+nn + " tbody").append("<button id="+nnn+" class='ui-button ui-widget ui-corner-all' backlogid=btn"+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+"  onClick=\"indi_switch('"+nnn+"','"+m+"','"+d+"','"+p+"','"+item.name+"');\"    >"+item.label+"</button>");
            }
        
        }

    })
}    
function buildlights(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.lights, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#"+nnn).length) {
            $("#"+nnn).val(item.state);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn+ " tbody").append("<tr><td><small>"+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.state+"'  label="+item.state+" /></td></tr>");
            };
            if (prop.permission=="2") {
                /* not available */
            }
        
        }

    })
}    
    
</script>

