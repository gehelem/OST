<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="jquery-ui.min.css">
<script src="external/jquery/jquery.js"></script>
<script src="jquery-ui.min.js"></script>
<link rel="stylesheet" href="ost.css">
</head><body><div id="OST"></div></body>
</html>

<script>

var ur = window.location.origin.replace("http://", "");
var result = ur.replace("http://", "");
var wsUri = "ws://"+ur+":9624";            
var websocket = null;

$(document).ready(function()
{
    initWebSocket();
});

function initWebSocket() {
    try {
        if (typeof MozWebSocket == 'function') WebSocket = MozWebSocket;
        if ( websocket && websocket.readyState == 1 ) websocket.close();
        
        websocket = new WebSocket( wsUri );
        websocket.onopen = function (evt) {
            console.log("CONNECTED");
            websocket.send( "{\"message\":\"readall\"}");
        };
        websocket.onclose = function (evt) {
            console.log("DISCONNECTED");
            $("#OST").empty();                      /* this shouldn't be here */
            $("#OST").tabs("refresh");              /* this shouldn't be here */
        };
        websocket.onmessage = function (evt) {
            var obj = jQuery.parseJSON( evt.data );
            console.log(obj);
            if (obj.event == 'moduledump') {
                m=obj.module;
                l=obj.modulelabel;
                buildmodule(m,l);
                
                var devices = obj.devices;
                $.each( devices, function(idev,dev) {
                    d=dev.devicenameshort;
                    l=dev.devicename;
                    builddevice(m,d,l);

                    var groups = dev.groups;
                    $.each( groups, function(igro,gro) {
                        g=gro.groupnameshort;
                        l=gro.groupname;
                        buildgroup(m,d,g,l);
                        var props = gro.properties;
                        $.each( props, function(ipro,pro) {
                            buildproperty(m,d,g,pro);
                        })

                    })
                    $("div#D"+m+d).tabs();              /* this shouldn't be here */    

                })
                $("div#D"+m).tabs();              /* this shouldn't be here */    


            }
            if (obj.event == 'updateproperty') {
                p=obj.property;
                buildproperty(obj.module,p.devicenameshort,p.groupnameshort,p);
            }
            if (obj.event == 'createproperty') {
                p=obj.property;
                builddevice  (obj.module,p.devicenameshort,p.devicename);
                $("#D"+obj.module+p.devicenameshort).tabs("refresh");              /* this shouldn't be here */
                buildgroup   (obj.module,p.devicenameshort,p.groupnameshort,p.groupname);
                $("#D"+obj.module).tabs("refresh");              /* this shouldn't be here */
                buildproperty(obj.module,p.devicenameshort,p.groupnameshort,p);
            }
            if (obj.event == 'removeproperty') { 
                    var dev   = obj.module+obj.property.devicenameshort;               /* this should be moved to a dedicated function */
                    var group = dev+obj.property.groupnameshort;
                    var prop  = group+obj.property.propname;
                    //console.log("REMOVE PROP "+prop);
                    $( "#P"+ prop ).children().remove();
                    $( "#P"+ prop ).remove();
                    
                    if (!($("#U"+ group).children().length > 0)){
                        //console.log("REMOVE GROUP "+group);
                        $("#U"+ group ).remove();
                        $("#D"+ group ).remove();
                        $("#L"+ group ).remove();
                    }
                    if (!($("#U"+ dev).children().length > 0)){
                        //console.log("REMOVE DEVICE "+dev);
                        $("#U"+ dev ).remove();
                        $("#D"+ dev ).remove();
                        $("#L"+ dev ).remove();
                    }

                
            }
            
        };
        
        websocket.onerror = function (evt) {
            console.log('ERROR: ' + evt.data);
        };
    } 
    catch (exception) {
        console.log('ERROR: ' + exception);
    }
}

function stopWebSocket() {
    if (websocket)  websocket.close();
}
            
function buildmodule(m,l) {

    if  (!($("div#D"+m).length)) {
        $("div#OST").append("<h1  id=H"+m+">"+l+"</h1>");
        $("div#OST").append("<div id=D"+m+"></div>");
        $("div#D"+m).append("<ul id=U"+m+"></ul>");
        
    };
    $("#OST").accordion({header: "h1",collapsible: true,autoHeight: false,navigation: true,heightStyle: "content" });
    $("#OST").accordion("refresh");  
    
}

function builddevice(m,d,l) {
    //console.log('BUILD DEVICE ' + m + "-"+ d + "-"+ l + "-");
    if  (!($("#D"+m+d).length >0)) {
        $("#D"+m).append("<div id=D"+m+d+"></div>");
        $("#U"+m).append("<li id=L"+m+d+"><a href=#D"+m+d+">"+l+"</a></li>");
        $("#D"+m+d).append("<ul id=U"+m+d+"></ul>");
    };
    //$("#D"+m).tabs("refresh");  
}

function buildgroup(m,d,g,l) {
    if  (!($("#D"+m+d+g).length > 0)) {
        //console.log('BUILD GROUP ' + m + "-" + d + "-"+ g + "-"+ l + "-");
        $("#D"+m+d).append("<div id=D"+m+d+g+"></div>");
        $("#U"+m+d).append("<li id=L"+m+d+g+"><a href=#D"+m+d+g+">"+l+"</a></li>");
        $("#D"+m+d+g).append("<ul id=U"+m+d+g+"></ul>");
    };
}

function buildproperty(m,d,g,p) {
    nn=m+d+g;
    nnp=nn+p.propname;
    if  (!($("#P"+nnp).length)) {
        div="<div id=P"+nnp+" ><table id=tab"+nnp+">"
        +"<tr><td>"
        +"<strong id=status"+nnp+" >"+"---"+"</strong>"
        +"<strong id=title"+nnp+" >"+p.label+"</strong></td><td>";
        
        if ((p.permission=="1"||p.permission=="2")&&(p.hasOwnProperty('numbers')||p.hasOwnProperty('texts'))) {
            div=div+"<button class='ui-button ui-widget ui-corner-all' "
            +"id=B"+nnp+ " data-json=\"\">set</button></tr>";
        }
        div=div+"</td></tr></table></div>";
        $("#U"+nn).append(div);
        //$("#status"+nnp).css("background-color", "gray");
        
        if ((p.permission=="1"||p.permission=="2")&&(p.hasOwnProperty('numbers'))) {
            $("#B"+nnp).data("json",p);
            $("#B"+nnp).on("click", function () {
                var pp=$(this).data("json");
                $.each( pp.numbers, function( ii, i ) {
                    pp.numbers[ii].value=document.getElementById(pp.modulename+pp.devicenameshort+pp.groupnameshort+pp.propname+i.name).value;
                })
                var obj = jQuery.parseJSON("{\"message\":\"setproperty\",\"property\":"+JSON.stringify(pp)+"}");
                console.log(obj);
                websocket.send(JSON.stringify(obj));
            });
            
        }

        
        if ((p.permission=="1"||p.permission=="2")&&(p.hasOwnProperty('texts'))) {
            $("#B"+nnp).data("json",p);
            $("#B"+nnp).on("click", function () {
                var pp=$(this).data("json");
                $.each( pp.texts, function( ii, i ) {
                    //console.log( "indi_number clicked: " + nnp+i.name);
                    pp.texts[ii].value=document.getElementById(pp.modulename+pp.devicenameshort+pp.groupnameshort+pp.propname+i.name).value;
                })
                
                var obj = jQuery.parseJSON("{\"message\":\"setproperty\",\"property\":"+JSON.stringify(pp)+"}");
                console.log(obj);
                websocket.send(JSON.stringify(obj));
            });
            
        }
        
    }
    if (p.state=="0") $("#status"+nnp).css("background-color", "gray");   
    if (p.state=="1") $("#status"+nnp).css("background-color", "green");   
    if (p.state=="2") $("#status"+nnp).css("background-color", "yellow");   
    if (p.state=="3") $("#status"+nnp).css("background-color", "red");   
    if (p.hasOwnProperty('texts'   )) buildtexts  (m,d,g,p);
    if (p.hasOwnProperty('numbers' )) buildnumbers(m,d,g,p);
    if (p.hasOwnProperty('switches')) buildswitchs(m,d,g,p);
    if (p.hasOwnProperty('lights'  )) buildlights (m,d,g,p);
    //$("div#D"+m+d+g).tabs();    
}
function buildtexts(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.texts, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#"+nnn).length) {
            $("#"+nnn).val(item.text);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn + " tbody").append("<tr><td><small> "+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.text+"'  label="+item.text+" /></td></tr>");
            };
            if (prop.permission=="2") {
                $("#tab"+nn+ " tbody").append(
                "<tr><td><small>"+item.label+"</small></td><td>"
                +"<input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.text+"'  label="+item.text+" />"
                );
            }
        
        }

    })
}                

function buildnumbers(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.numbers, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#"+nnn).length) {
            $("#"+nnn).val(item.value);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn + " tbody").append("<tr><td><small> "+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.value+"'  label="+item.value+" /></td></tr>");
            };
            if (prop.permission=="2") {
                $("#tab"+nn+ " tbody").append(
                "<tr><td><small>"+item.label+"</small></td><td>"
                +"<input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.value+"'  label="+item.value+" />"
                );
            }
        
        }

    })
}    
function buildswitchs(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.switches, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#bbb"+nnn).length) {
            $("#bbb"+nnn).val(item.state);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn+ " tbody").append("<tr><td><small>"+item.label+"</small></td><td><input class='ui-text ui-widget ui-corner-all' type='text' id="+nnn+" data-btn="+nnn+" data-modulename="+m+" data-propname="+p+" data-name="+item.name+" value='"+item.state+"'  label="+item.state+" /></td></tr>");
            
            }
            if (prop.permission=="1" || prop.permission=="2") {
                $("#tab"+nn + " tbody").append("<button id=bbb"+nnn+" class='ui-button ui-widget ui-corner-all' backlogid=btn"+nnn
                +" value="+item.state
                +" data-value=\"\""
                +" data-btn=\"\" >"+item.label+"</button>");
                $("#bbb"+nnn).data("btn",prop);
                $("#bbb"+nnn).data("value",item.state);
                $("#bbb"+nnn).val(item.state);
            }
            $("#bbb"+nnn).on("click", function () {
                var pp=$(this).data("btn");
                /*$.each( pp.switches, function( ii, i ) {
                    //console.log( "switch clicked: " + pp.modulename+pp.devicenameshort+pp.groupnameshort+pp.propname+i.name);
                    pp.switches[ii].state=document.getElementById("bbb"+pp.modulename+pp.devicenameshort+pp.groupnameshort+pp.propname+i.name).value;
                })*/
                

                var message = "{\"message\":\"setproperty\",\"property\":{\"devicename\":\""+pp.devicename
                +"\",\"devicenameshort\":\""+pp.devicenameshort
                +"\",\"groupname\":\""+pp.groupname
                +"\",\"groupnameshort\":\""+pp.groupnameshort
                +"\",\"label\":\""+pp.label
                +"\",\"modulename\":\""+pp.modulename
                +"\",\"propname\":\""+pp.propname
                +"\",\"switches\":[{\"name\":\""+item.name+"\"}]}}";
                console.log(jQuery.parseJSON(message));
                websocket.send( message);
                
                
                
            })
            
        
        }
        if (item.state) $("#bbb"+nnn).css("background", "green");   
        if (!item.state) $("#bbb"+nnn).css("background", "");   

    })
}    
function buildlights(m,d,g,prop) {

    p=prop.propname;
    $.each( prop.lights, function( iitem, item ) {
        nn=m+d+g+p;
        nnn = nn+item.name;
        if ($("#status"+nnn).length) {
            //$("#"+nnn).val(item.state);
        } else {
            if (prop.permission=="0") {
                $("#tab"+nn+ " tbody").append("<tr>"
                +"<td><strong id=status"+nnn+" >"+"---"+"</strong></td>"
                +"<td><small>"+item.label+"</small></td>"
                +"</tr>");
            };
            if (prop.permission=="2") {
                /* not available */
            }
        
        }
        if (item.state=="0") $("#status"+nnn).css("background-color", "gray");   
        if (item.state=="1") $("#status"+nnn).css("background-color", "green");   
        if (item.state=="2") $("#status"+nnn).css("background-color", "yellow");   
        if (item.state=="3") $("#status"+nnn).css("background-color", "red");  


    })
}    

</script>

